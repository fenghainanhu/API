<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>待机和唤醒_silvcn_新浪博客</title>
<meta name="keywords" content="待机和唤醒_silvcn_新浪博客,silvcn," />
<meta name="description" content="待机和唤醒_silvcn_新浪博客,silvcn," />
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
<meta http-equiv="mobile-agent" content="format=html5; url=http://blog.sina.cn/dpool/blog/s/blog_45dc1205010177dg.html?vt=4">
<meta http-equiv="mobile-agent" content="format=wml; url=http://blog.sina.cn/dpool/blog/ArtRead.php?nid=45dc1205010177dg&vt=1">
<!–[if lte IE 6]>
<script type="text/javascript">
try{
document.execCommand("BackgroundImageCache", false, true);
}catch(e){}
</script>
<![endif]–>
<script type="text/javascript">
window.staticTime=new Date().getTime();
</script>
<link rel="pingback" href="http://upload.move.blog.sina.com.cn/blog_rebuild/blog/xmlrpc.php" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://upload.move.blog.sina.com.cn/blog_rebuild/blog/xmlrpc.php?rsd" />
<link href="http://blog.sina.com.cn/blog_rebuild/blog/wlwmanifest.xml" type="application/wlwmanifest+xml" rel="wlwmanifest" />
<link rel="alternate" type="application/rss+xml" href="http://blog.sina.com.cn/rss/1172050437.xml" title="RSS" />
<link href="http://simg.sinajs.cn/blog7style/css/conf/blog/article.css" type="text/css" rel="stylesheet" /><link href="http://simg.sinajs.cn/blog7style/css/common/common.css" type="text/css" rel="stylesheet" /><link href="http://simg.sinajs.cn/blog7style/css/blog/blog.css" type="text/css" rel="stylesheet" /><link href="http://simg.sinajs.cn/blog7style/css/module/common/blog.css" type="text/css" rel="stylesheet" /><style id="tplstyle" type="text/css">@charset "utf-8";@import url("http://simg.sinajs.cn/blog7newtpl/css/30/30_1/t.css");
</style>
<style id="positionstyle"  type="text/css">
</style>
<style id="bgtyle"  type="text/css">
</style>
<style id="headtyle"  type="text/css">
</style>
<style id="navtyle"  type="text/css">
</style>
<script type="text/javascript" src="http://d1.sina.com.cn/litong/zhitou/sspnew.js"></script></head>
<body>
<!--$sinatopbar-->
<div style="z-index:512;" class="nsinatopbar">
  <div style="position:absolute;left:0;top:0;" id="trayFlashConnetion"></div>
  <div class="ntopbar_main"> 
    <a id="login_bar_logo_link_350" href="http://blog.sina.com.cn" target="_blank"><img class="ntopbar_logo" src="http://simg.sinajs.cn/blog7style/images/common/topbar/topbar_logo.gif" width="100" alt="新浪博客"></a>
    <div class="ntopbar_floatL">
      <div class="ntopbar_search" id="traySearchBar"></div>
	  <div class="ntopbar_ad" id="loginBarActivity" style="display:none;"></div>
    </div>
    <div class="ntopbar_loading"><img src="http://simg.sinajs.cn/blog7style/images/common/loading.gif">加载中…</div>
  </div>
</div>
<!--$end sinatopbar-->

<div class="sinabloga" id="sinabloga">
	<div id="sinablogb" class="sinablogb">

	   
 <div id="sinablogHead" class="sinabloghead">
     <div style="display: none;" id="headflash" class="headflash"></div>
	   <div id="headarea" class="headarea">
      <div id="blogTitle" class="blogtoparea">
      <h1 id="blogname" class="blogtitle"><a href="http://blog.sina.com.cn/u/1172050437"><span id="blognamespan">加载中...</span></a></h1>
	  		
					<div id="bloglink" class="bloglink"><a href="http://blog.sina.com.cn/u/1172050437">http://blog.sina.com.cn/u/1172050437</a>  <a onclick="return false;" class="CP_a_fuc" href="#" id="SubscribeNewRss">[<cite>订阅</cite>]</a><a class="CP_a_fuc" href="javascript:void(scope.pa_add.add('1172050437'));">[<cite>手机订阅</cite>]</a></div>
      </div>
      <div class="blognav" id="blognav">
      			  <div id="blognavBg" class="blognavBg"></div> <div class="blognavInfo"> 
		<span><a   href="http://blog.sina.com.cn/u/1172050437">首页</a></span>
      <span><a class="on" href="http://blog.sina.com.cn/s/articlelist_1172050437_0_1.html">博文目录</a></span>
      <span><a href="http://photo.blog.sina.com.cn/u/1172050437">图片</a></span>
      <span class="last"><a  href="http://blog.sina.com.cn/s/profile_1172050437.html">关于我</a></span></div>
      </div>      		      		 	
      
             <div class="autoskin" id="auto_skin">
       </div>

<div class="adsarea">
     <a href="#"><div id="template_clone_pic" class="pic"></div></a>
     <div id="template_clone_link" class="link wdc_HInf"></div>
     <div id="template_clone_other" class="other"></div>        
</div>
    </div>
    </div>
    
    <!--主题内容开始 -->
    <div class="sinablogbody" id="sinablogbody">
		
	<!--第一列start-->
    <div id="column_1" class="SG_colW21 SG_colFirst"><div class="SG_conn" id="module_901">
    <div class="SG_connHead">
            <span class="title" comp_title="个人资料">个人资料</span>
            <span class="edit">
                        </span>
    </div>
    <div class="SG_connBody">
        <div class="info">
                         
            <div class="info_img" id="comp_901_head"><img src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" real_src ="http://portrait6.sinaimg.cn/1172050437/blog/180" id="comp_901_head_image" width="180" height="180" alt="silvcn" title="silvcn" /></div>
            
            <div class="info_txt">
              <div class="info_nm">
                <img id="comp_901_online_icon" style="display:none;" class="SG_icon SG_icon1" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" width="15" height="15" align="absmiddle" />
                <span class="SG_txtb"><strong id="ownernick">silvcn                                </strong></span>
                
                <div class="clearit"></div>
              </div>
              <div class="info_btn1">
                <a target="_blank" href="http://weibo.com/u/1172050437?source=blog" class="SG_aBtn SG_aBtn_ico"><cite><img class="SG_icon SG_icon51" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" width="15" height="15" align="absmiddle" />微博</cite></a>
                <div class="clearit"></div>
              </div>
    <div class="SG_j_linedot"></div>        <div class="info_locate" id = "info_locate_id">
<div class="SG_j_linedot"></div>
<div class="info_btn2">
    <p>
    <a href="javascript:void(0);" class="SG_aBtn " id="comp901_btn_invite"><cite >加好友</cite></a>
    <a href="javascript:void(0);" class="SG_aBtn" id="comp901_btn_sendpaper"><cite >发纸条</cite></a>
    </p>
    <p>
    <a href="http://blog.sina.com.cn/s/profile_1172050437.html#write" class="SG_aBtn"   id="comp901_btn_msninfo"><cite>写留言</cite></a>
    <a href="#" onclick="return false;" class="SG_aBtn"  id="comp901_btn_follow"><cite onclick="Module.SeeState.add()">加关注</cite></a>
    </p>
    <div class="clearit"></div>
</div>
<div class="SG_j_linedot"></div>
</div>
                  <div class="info_list">     
                                   <ul class="info_list1">
                    <li><span class="SG_txtc">博客等级：</span><span id="comp_901_grade"><img src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" real_src="http://simg.sinajs.cn/blog7style/images/common/number/8.gif"  /></span></li>
                    <li><span class="SG_txtc">博客积分：</span><span id="comp_901_score"><strong>0</strong></span></li>
                    </ul>
                    <ul class="info_list2">
                    <li><span class="SG_txtc">博客访问：</span><span id="comp_901_pv"><strong>2,032</strong></span></li>
                    <li><span class="SG_txtc">关注人气：</span><span id="comp_901_attention"><strong>1</strong></span></li>
                    <li><span class="SG_txtc">获赠金笔：</span><strong id="comp_901_d_goldpen">0支</strong></li>
                    <li><span class="SG_txtc">赠出金笔：</span><strong id="comp_901_r_goldpen">0支</strong></li>
					<li class="lisp" id="comp_901_badge"><span class="SG_txtc">荣誉徽章：</span></li>
                    </ul>
                  </div>
<div class="clearit"></div>
    </div>
    <div class="clearit"></div>
</div>
            </div>       
            <div class="SG_connFoot"></div>
</div>
<div id="module_903" class="SG_conn ">
    <div class="SG_connHead">
    <span comp_title="相关博文" class="title">相关博文</span>
    <span class="edit"> </span>
    </div>
    <div class="SG_connBody">
    <div class="atcTitList relaList">        <ul class="">

                <li class="SG_j_linedot1" style="display:none;">
            <p id="atcTitLi_SLOT_41" class="atcTitCell_tit SG_dot" style="display:none">
        </p>
        </li>
        <li class="SG_j_linedot1" style="display:none;">
            <p id="atcTitLi_SLOT_42"  class="atcTitCell_tit SG_dot" style="display:none">
        </p>
        </li>
        
                	</ul>
    <div class="atcTit_more"><span class="SG_more"><a href="http://blog.sina.com.cn/" target="_blank">更多&gt;&gt;</a></span></div></div>    </div>
    <div class="SG_connFoot"></div>
  </div>
<div class="SG_conn " id="module_904">
<div class="SG_connHead">
<span class="title">推荐博文</span>
</div>
<div class="SG_connBody ">
	<div class="atcTitList relaList">		<ul class="">
			<li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="第1365篇&bull;贵圈" target="_blank" href="http://blog.sina.com.cn/s/blog_5054769e0102wxfc.html?tj=2?tj=2">第1365篇&bull;贵圈</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1347712670" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="这笔买卖，苏宁花光了三年利润" target="_blank" href="http://blog.sina.com.cn/s/blog_655eee230102wmx7.html?tj=2?tj=2">这笔买卖，苏宁花光了三年利润</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1700720163" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="2016年全国各地高考作文汇总" target="_blank" href="http://blog.sina.com.cn/s/blog_5f0f1d570102wgf8.html?tj=2?tj=2">2016年全国各地高考作文汇总</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1594826071" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="我怀念英雄不问出处的年代" target="_blank" href="http://blog.sina.com.cn/s/blog_62914aab0102wfw6.html?tj=2?tj=2">我怀念英雄不问出处的年代</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1653689003" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="奥巴马访广岛的反华阴谋" target="_blank" href="http://blog.sina.com.cn/s/blog_470071c90102whiw.html?tj=2?tj=2">奥巴马访广岛的反华阴谋</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1191211465" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="审视“海归卖煎饼”须跳出海归标" target="_blank" href="http://blog.sina.com.cn/s/blog_611792930102wjyu.html?tj=2?tj=2">审视“海归卖煎饼”须跳出海归标</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1628934803" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="超龄考者的“高考秀”" target="_blank" href="http://blog.sina.com.cn/s/blog_554eff910102wr8q.html?tj=2?tj=2">超龄考者的“高考秀”</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1431240593" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="高考前一天，他给班上39个学生" target="_blank" href="http://blog.sina.com.cn/s/blog_655eee230102wmyi.html?tj=2?tj=2">高考前一天，他给班上39个学生</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1700720163" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="高考作文要怎么出题，段子手才满" target="_blank" href="http://blog.sina.com.cn/s/blog_1382c65610102wnrc.html?tj=2?tj=2">高考作文要怎么出题，段子手才满</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/5237400929" class="SG_linkb"></a></p>
		</li><li class="SG_j_linedot1"><p class="atcTitCell_tit SG_dot"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" title="44岁小学教师参加高考并非“励" target="_blank" href="http://blog.sina.com.cn/s/blog_54a98ec20102wawn.html?tj=2?tj=2">44岁小学教师参加高考并非“励</a></p>
        <p class="atcTitCell_nm"><a suda-uatrack="key=blog_tjblog&value=h_tjblog" target="_blank" href="http://blog.sina.com.cn/u/1420398274" class="SG_linkb"></a></p>
		</li>		</ul>
		<div id="atcPicList">
		</div>
	<div class="atcTit_more"><span class="SG_more"><a target="_blank" href="http://blog.sina.com.cn/">查看更多</a>&gt;&gt;</span></div></div></div>
<div class="SG_connFoot"></div>
</div>
</div>
	<!--第一列end-->
	
	<!--第二列start-->
	<div id="column_2" class="SG_colW73">	
<div id="module_920" class="SG_conn">
	<div class="SG_connHead">
	    <span comp_title="正文" class="title">正文</span>
	    <span class="edit"><span id="articleFontManage" class="fontSize">字体大小：<a href="javascript:;" onclick="changeFontSize(2);return false;">大</a> <strong>中</strong> <a href="javascript:;" onclick="changeFontSize(0);return false;">小</a></span></span>
	</div>
    <div class="SG_connBody">
<!--博文正文 begin -->
	<div id="articlebody" class="artical" favMD5='{"45dc1205010177dg":"4c9008288df152953352303b6f35e5e5"}'>
		<div class="articalTitle"> 
			
								<h2 id="t_45dc1205010177dg" class="titName SG_txta">待机和唤醒</h2>
			
					<span class="img2">
				<img width="15" height="15" align="absmiddle" title="此博文包含图片" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" class="SG_icon SG_icon18"/>	
			</span>
					<span class="time SG_txtc">(2012-11-11 21:05:40)</span><div class="turnBoxzz"><a href="javascript:;" class="SG_aBtn SG_aBtn_ico SG_turn"  action-type="reblog" action-data="{srcBlog:1, blogId:'45dc1205010177dg'}"><cite><img class="SG_icon SG_icon111" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" width="15" height="15" align="absmiddle">转载<em class="arrow">▼</em></cite></a></div>		</div>
		<div class="articalTag" id="sina_keyword_ad_area">
			<table>
				<tr>
					<td class="blog_tag">
					<script>
					var $tag='';
					var $tag_code='0b51aa97d5b6eb5f830b6fbbe70da697';
					var $r_quote_bligid='45dc1205010177dg';
					var $worldcup='0';
					var $worldcupball='0';
					</script>
										</td>
					<td class="blog_class">
										</td>
				</tr>
			</table>
		</div>
						<!-- 正文开始 -->
		<div id="sina_keyword_ad_area2" class="articalContent   ">
			<p>一、概述</P>
<p>
点屏灭屏根本上是一个按键的输入操作，涉及的linux的输入设备管理，modem和app的通信，操作共享内存的机制等，简单流程如下示。</P>
<p><img src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" real_src ="http://s10.sinaimg.cn/mw690/45dc1205x7b0598ff2b59&amp;690" WIDTH="512" HEIGHT="384"  ALT="待机和唤醒"  TITLE="待机和唤醒" /></P>
<p><b>点屏灭屏流程示意图</B></P>
<p>&nbsp;<wbr></P>
<p>二、待机流程介绍</P>
<p>1、modem侧对按键的处理</P>
<p><b>中断挂接</B></P>
<p>
modem侧按键的中断向量是PM_KPD_PWR_KEY_ON_IRQ_HDL(按下)和PM_KPD_PWR_KEY_OFF_IRQ_HDL(松开)，在初始化接口pm_pwr_key_init中用pm_set_irq_multi_handle接口将按下power键的中断向量PM_KPD_PWR_KEY_ON_IRQ_HDL和中断服务函数pm_pwr_key_pressed_isr关联起来。</P>
<p>
按下power键产生的中断调用中断服务函数pm_pwr_key_pressed_isr。先调用event_reg-&gt;event_callback指向的接口hs_pwr_key_event_cb函数，hsi_pwr_key_init中用pm_hs_event_register将hs_pwr_key_event_cb放到PM_HS_EVENT_PWR_KEY对应的event_callback中。之后解除中断PM_KPD_PWR_KEY_ON_IRQ_HDL和对应服务接口pm_pwr_key_pressed_isr的绑定，置全局标记pm_pwr_key_status为TRUE，绑定松开按键中断PM_KPD_PWR_KEY_OFF_IRQ_HDL和对应服务函数pm_pwr_key_released_isr。</P>
<p><b>事件event</B><b>的处理</B></P>
<p>
回调接口hs_pwr_key_event_cb-&gt;hs_pwr_key_init_pwr_end_determination中用hs_report_event发送event，具体实现是用hs_event_buffer_insert将该事件插入到buffer中，之后用hsi_signal_dispatch-&gt;hs_os_set_sigs置上标志位。而hs_task任务一直在等待(hs_os_wait)event的发生，包括HS_EVNT_BUFF_DRAIN_SIG事件。之后用hs_os_clr_sigs清除event的buffer，再用hsi_drain_event_buffer轮询注册的各event对应的回调接口，比如ui_key_event_cb。</P>
<p><b>向app</B><b>发信号</B></P>
<p>
响应event的回调接口用smsm_state_modify切换到对应的状态，用smsm_notify_other_hosts-&gt;smsm_target_send_interrupt给app发送中断通知app读取共享内存中modem写入的用户按power键的按键信息，全局变量smsm_info中保存了中断表interrupt_tbl，在smsm_init-&gt;smsm_target_init_interrupt中初始化，smsm_send_interrupt，给app侧的发送中断使用了中断号SMSM_M2A_OUT。</P>
<p>&nbsp;<wbr></P>
<p><b>Modem</B><b>的状态机</B></P>
<p>
modem维护了一个状态机用来管理modem上所有电源管理请求，状态机DEMMasterStateMachine被modemTargetSignalsProces<wbr>s调用，初始化时在DEMTargetInit中用DEMControlTargetInit注册modemTargetSignalsProces<wbr>s到全局指针gDEMTargetSignalsProcess<wbr>上。起动dem_task任务，while(1)死循环中用rex_wait等待全局信号gDEMSigs，如果等到了就运行状态机切换到对应的状态，可以用rex_set_sigs(&amp;dem_tcb,
DEM_APPS_SM)唤醒状态机。</P>
<p>等待的信号一共有5个，如下示：</P>
<p>DEM_APPS_VERSION_SIG 用来处理app发来的版本读取信号，直接读取数据不用切换状态；</P>
<p>DEM_APPS_SM 处理app的共享内存请求，切换状态机；</P>
<p>DEM_APPS_TIMER_SIG处理app侧timer的共享内存请求，切换状态机；</P>
<p>DEM_APPS_SMEM_CMD_SIG app侧共享内存的cmd请求；</P>
<p>DEM_NV_RD_WR_SIG 处理modem本端NV的读写请求；</P>
<p>
待机的最后app处理按键信息准备待机时向modem发送的swfi中断用的就是上述状态机的机制，app触发swfi中断后，modem响应中断并调用中断服务函数appsSwfiIsr中会用rex_set_sigs触发状态机工作。中断向量TRAMP_A2M_PWR_DOWN_IRQ都对应appsSwfiIsr，该中断是FIQ。</P>
<p>&nbsp;<wbr></P>
<p><b>内核机制——</B><b>共享内存</B></P>
<p>rpc通信是一种访问共享内存的机制，当前接触到4种访问共享内存的机制，分别是下面几种情况：</P>
<p>1、&nbsp;<wbr> 直接内存访问</P>
<p>通过smem_alloc得到共享内存的地址，直接进行访问。</P>
<p>2、&nbsp;<wbr> PRO_COMM访问</P>
<p>
modem和app通过访问及判断下面的结构以全局变量smem_proc_comm为载体进行通信，通过发送命令cmd，用status记录当前命令状态，用date1和date2携带关键的方式通信。smem_proc_comm[SMEM_PROC_COMM_APPS_PROC].command是否为0表征是否存在app命令，command的数值表示当前发送的哪一条命令。用枚举smem_proc_comm_cmd_type记录PROC_COMM命令的种类。发起端先查询对端的状态是否ready，如果ready则将cmd和date1、date2写到共享内存区，之后触发对端的中断，等待对端处理，对端产生中断后会触发中断服务函数的调用处理发起端发来的信息，之后把处理过的信息写到共享内存，将cmd_done命令写入到共享内存，发起端查询到对端的done命令后读取共享内存中的数据结束proc_comm的处理。</P>
<p>typedef struct</P>
<p>{</P>
<p>&nbsp;<wbr> uint32 command;</P>
<p>&nbsp;<wbr> uint32 status;</P>
<p>&nbsp;<wbr> uint32 data1;</P>
<p>&nbsp;<wbr> uint32 data2;</P>
<p>} smem_proc_comm_data_type;</P>
<p>typedef enum</P>
<p>{</P>
<p>&nbsp;<wbr> SMEM_PROC_COMM_APPS_PROC =
0x0,&nbsp;<wbr>&nbsp;<wbr></P>
<p>&nbsp;<wbr>
SMEM_PROC_COMM_MODEM_PROC,&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr></P>
<p>&nbsp;<wbr> SMEM_PROC_COMM_SPARE0_PROC,</P>
<p>&nbsp;<wbr> SMEM_PROC_COMM_SPARE1_PROC</P>
<p>} smem_proc_comm_proc_type;</P>
<p>&nbsp;<wbr></P>
<p>3、&nbsp;<wbr> SMD通信</P>
<p>SMD即Shared Memory
Driver，在SMEM_CHANNEL_ALLOC_TBL存储空间中，保存了定义的channel(port)。</P>
<p>
modem侧smd的中断服务函数为smd_smsm_isr。Modem侧对应中断向量号TRAMP_A2M_0_IRQ，响应中断后置信号标志rex_set_sigs(&amp;smd_tcb,(rex_sigs_type)(SMD_EV</P>
<p>ENT_SIG))。</P>
<p>&nbsp;<wbr></P>
<p>4、&nbsp;<wbr> RPC通信</P>
<p>
rpcrouter_smd_xprt.c和smd_rpcrouter.c是RPC相关的主要文件,RPC是建立在SMD基础之上的通信方式。以kernel侧为例：</P>
<p>先看rpcrouter_smd_xprt.c文件的初始化函数：</P>
<p>rpcrouter_smd_remote_probe</P>
<p>1)、初始化xprt</P>
<p>2)、通过smd_open打开RPCCALL，并注册回调函数</P>
<p>3)、 msm_rpcrouter_xprt_notify加xprt，唤醒读操作</P>
<p>4)、设置SMSM_APPS_STATE状态SMSM_RPCINIT</P>
<p>
通过msm_rpcrouter_add_xprt加载xprt后，do_read_data不停的读数据，没有数据时在rr_read函数中等待，wait_event(xprt_info-&gt;read_wait,
xprt_info-&gt;xprt-&gt;read_avail()
&gt;=
len);当读到数据时，唤醒读等待的操作wake_up(&amp;ept-&gt;wait_q);之后自己继续读数据queue_work(xprt_info-&gt;workqueue,
&amp;xprt_info-&gt;read_data);</P>
<p>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
Kernel侧的按键信息读取通过RPC方式获取。</P>
<p>&nbsp;<wbr></P>
<p>2、Kernel侧对按键的处理</P>
<p><b>初始化时的操作</B></P>
<p>
在初始化时hs_rpc_cb_init中调用msm_rpc_register_client注册好的hs_cb_func函数，msm_rpc_register_client中会注册按键的回调接口hs_cb_func。</P>
<p><b>&nbsp;<wbr></B></P>
<p><b>关键线程介绍</B></P>
<p>
注册端点的接口指针cb_restart_teardown(cb_restart_teardown)和ept-&gt;cb_restart_setup
(cb_restart_setup)，之后起了一个线程rpc_clients_thread，用来读写按键的输入，线程rpc_clients_thread最后调用wait_event_interruptible_timeout使该进程将不会继续运行直到被唤醒，然后被添加到等待队列wq中，置为可中断的挂起状态，反复检查condition是否成立，如果成立则退出，如果不成立则继续休眠；条件满足后，即把本进程运行状态置为运行态，并将__wait从等待队列中清除掉。</P>
<p>
另外起了一个线程rpc_clients_cb_thread，用来完成实时的回调，回调线程一直在等待事件的发生来触发client-&gt;cb_wait，而该事件会在读线程rpc_clients_thread的最后当可以读到数据时触发wake_up(&amp;client-&gt;cb_wait)，否则触发所有pend状态的请求wake_up(&amp;client-&gt;reply_wait)。</P>
<p>
cb_wait和reply_wait是不同的，调用msm_rpc_client_req和msm_rpc_client_req2的都挂在reply_wait上；cb_wait上则是通过msm_rpc_register_client和msm_rpc_register_client2注册用户client的接口，在电池、dog、usb中都有用到，比如msm_batt_get_vbatt_voltage等。</P>
<p>&nbsp;<wbr></P>
<p><b>处理机制</B></P>
<p>
msm_rpc_client_req是直接向对端发送rpc请求，用msm_rpc_setup_req封装请求字段，用msm_rpc_write向共享内存写数据，将任务置成D状态，之后等待modem给app的响应，如果rpc_rsp-&gt;reply_stat是RPCMSG_REPLYSTAT_ACCEPTED，rpc_rsp-&gt;data.acc_hdr.accept_stat是RPC_ACCEPTSTAT_SUCCESS则说明请求成功；msm_rpc_register_client是注册了一个RPC的客户端，上来就挂到__msm_rpc_read的wait_event_interruptible上，当ept_packet_available返回有可读数据后继续放下走读数据，具体读操作就是从上ept-&gt;read_q的链表首个元素，读之后清除链表。</P>
<p>
而在do_read_data中才会add(list_add_tail)链表(ept-&gt;read_q)的元素，具体调用关系rpcrouter_smd_remote_probe/rpcrouter_smd_loopback_probe-&gt;rpcrouter_smd_remote_notify/
rpcrouter_smd_loopback_notify-&gt;msm_rpcrouter_xprt_notify-&gt;xprt_open_worker-&gt;msm_</P>
<p>rpcrouter_add_xprt-&gt;do_read_data。</P>
<p>
其中msm_rpcrouter_xprt_notify是读共享内存的回调读函数，probe中会smd_open虚拟出TTY设备。</P>
<p>
do_read_data会触发线程rpc_clients_thread工作，进而线程rpc_clients_cb_thread被触发，调用接口xdr_recv_req(&amp;client-&gt;cb_xdr,
&amp;req)；然后根据版本号1、2来回调cb_func2/cb_func(msm_rpc_register_client和msm_rpc_register_client2的区别就在于版本号client-&gt;version)。</P>
<p>&nbsp;<wbr></P>
<p><b>内核机制</B></P>
<p>1）、wake_unlock和wake_lock</P>
<p>Wake Lock是一种锁的机制, wake_lock 加锁，禁止进入待机，wake_unlock 解锁，允许进入待机。</P>
<p>
只要有人拿着这个锁，系统就无法进入休眠，可以被用户态程序和内核获得。这个锁可以是有超时的或者是没有超时的，超时的锁会在时间过去以后自动解锁，非超时的操作等完成后用wake_unlock重新允许进入待机。如果没有锁了或者超时了，内核就会启动休眠的那套机制来进入休眠。</P>
<p>从应用侧看，如果向节点wakelock中写入信息(比如执行echo
abc&gt;wake)则说明有锁生效，内容不清空，设备就不会进入待机流程。</P>
<p>&nbsp;<wbr></P>
<p><b>按键回调接口</B></P>
<p>
hs_cb_func将传过来的buffer中的数据按照app侧实际大小端bit数转换(XFS_NATIVE_HOST是大端定义宏)，之后调用process_hs_rpc_request分析按键(按键的详细信息主要是buffer中hs_event_cb_recv的key.code和key.parm)种类，发起一个输入事件event，具体是process_hs_rpc_request判断proc是否是HS_EVENT_CB_PROC，如果是才调用process_subs_srvc_callback，进而调用report_hs_key把key.code和key.parm传进去，调用hs_find_key查找具体是哪个按键，根据key_code是否是HS_REL_K来决定传参是key_parm还是key_code，如果是耳机键(插入耳机线被看做是输入耳机键)则用input_report_switch输入一个切换事件(event)，否则用input_report_key输入一个按键事件，最后用input_sync输入一个输入同步的事件event，全局变量hs_key_map实现了modem侧按键定义和kernel侧按键定义的转换。</P>
<p>hs_cb_func
-&gt;process_hs_rpc_request-&gt;process_subs_srvc_callback-&gt;report_hs_key</P>
<p>
输入事件是evdev事件，上报给上层应用，由上层应用来处理按键的上报。最终应用会调用SetPowerState设置背光的强度，通过向内核提供的节点/sys/power/stat写入mem信息完成灭屏操作，对应内核会调用state_store实现待机，如果是唤醒则向节点stat中写入on信息。Android中on的值为0，mem的值为3，因此log上会出现0和3之间的状态切换，应用根据当前手机的状态来判断需要向节点写入0还是写入3，输入信息和写入节点信息的操作是异步的，因此可能会出现3-3/0-0的情况。</P>
<p>&nbsp;<wbr></P>
<p><b>Kernel</B><b>侧具体挂起/</B><b>唤醒流程</B></P>
<p>
挂起/唤醒时先是调用request_suspend_state，根据输入的状态判断是灭屏还是亮屏，之后唤醒early_suspend_work(灭屏)或者late_resume_work(亮屏)的工作队列唤醒或者挂起的队列执行接口是late_resume和early_suspend。</P>
<p>static DECLARE_WORK(late_resume_work, late_resume);</P>
<p>static DECLARE_WORK(early_suspend_work, early_suspend);</P>
<p>灭屏操作时，early susupend中调用list_for_each_entry(pos,
&amp;early_suspend_handlers,
link)将初始化时注册的处理函数逐个调用执行，之后调用suspend_sys_sync_queue，此时系统已经进入浅度睡眠状态，关闭了LCD、传感器等设备，如果此时有wake_lock的锁存在(比如插上USB充电线)，则不会再继续调用suspend_enter进入深度睡眠状态。</P>
<p>最后调用wake_unlock告诉系统已解锁，可以进入休眠状态，</P>
<p>
唤醒main_wake_lock，wake_unlock中会触发suspend_work_queue队列工作，suspend_work对应接口suspend。</P>
<p>主要工作如下：</P>
<p>1）、suspend_sys_sync_queue用来同步文件系统；</P>
<p>2）、suspend_prepare用来挂起用户空间和内核空间的线程；</P>
<p>挂起线程的时候如果出现挂起应用线程失败的情况，则将之前挂起的线程全部恢复，之后重复进入挂起应用线程的路程。</P>
<p>
3）、通过suspend_devices_and_enter中的suspend_console挂起控制台，此时串口停止打印，后续的串口打印都存在buffer中，等待下次唤醒的时候唤醒控制台之后再从buffer里打出到串口上；</P>
<p>4）、通过suspend_devices_and_enter中的dpm_suspend_start挂起设备；</P>
<p>
5）、通过suspend_devices_and_enter中suspend_enter的disable_nonboot_cpus
core0挂起core1，</P>
<p>6）、用syscore_suspend挂起app侧core0 system
core注册的挂起接口，syscore指的是和cpu密切相关的特性禁止设置的接口，比如cpu的频率、timer等；</P>
<p>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
7）、如果syscore_suspend成功，并且此时没有唤醒的请求pending，则调用suspend_ops-&gt;enter(在初始化msm_pm_init时suspend_set_ops会将msm_pm_ops挂在全局变量suspend_ops上面)对应msm_pm_enter接口，完成CPU进入待机的具体操作</P>
<p>msm_pm_enter中流程如下：</P>
<p>1)、check是否是core0，此时core1已经被disable掉了，如果不是core0，则直接退出；</P>
<p>2)、用msm_pm_timer_enter_suspend挂起core0的定时器；</P>
<p>
3)、判断具体调用下面4个接口中的哪一个，配置变量msm7x27a_pm_data赋给msm_pm_modes，最后赋给局部变量allow，加log打印如下：</P>
<p>allow[MSM_PM_SLEEP_MODE_WAIT_FOR_INTERRUPT]=1.</P>
<p>allow[MSM_PM_SLEEP_MODE_RAMP_DOWN_AND_WAIT_FOR_INTERRUPT]=0.</P>
<p>allow[MSM_PM_SLEEP_MODE_POWER_COLLAPSE_STANDALONE]=1.</P>
<p>allow[MSM_PM_SLEEP_MODE_POWER_COLLAPSE]=1.</P>
<p>allow[MSM_PM_SLEEP_MODE_APPS_SLEEP]=0.</P>
<p>allow[MSM_PM_SLEEP_MODE_POWER_COLLAPSE_SUSPEND]=0.</P>
<p>allow[MSM_PM_SLEEP_MODE_POWER_COLLAPSE_NO_XO_SHUTDOWN]=0.</P>
<p>四个接口的区别如下</P>
<p>msm_pm_power_collapse：待机并完成和modem的握手，通知modem给app掉电；</P>
<p>msm_pm_power_collapse_standalone：待机但不通知modem；</P>
<p>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
msm_pm_swfi (true)：直接用msm_arch_idle设置cpu寄存器进入SWFI状态</P>
<p>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
msm_pm_swfi(false)：直接用msm_arch_idle设置cpu寄存器进入SWFI状态</P>
<p>
待机的根本操作是通过操作CP15寄存器清空icache和dcache，之后通过共享内存给modem发一个握手信息，modem响应这个握手，直接给app侧的cpu掉电。同时modem也会停掉大部分内容，只剩下32K时钟相关的mpm模块，19.2M和tcxo模块都关掉。</P>
<p>
msm_pm_power_collapse函数中先通过获取共享内存的接口smsm_get_state来判断modem的DEM是否ready，ready时执行中断接口msm_pm_irq_extns
-&gt;enter_sleep1，对应文件irq_vic.c中的msm_irq_enter_sleep1接口返回当前中断使能的中断项作为IRQ_MASK，保存在全局变量msm_pm_smem_data中，以备唤醒时恢复使用。中断函数的指针在初始化msm7x27a_pm_init接口中用msm_pm_register_irqs的msm_pm_set_irq_extns接口把msm7x27a_pm_irq_calls挂在在全局指针msm_pm_irq_extns上。</P>
<p>msm_sirc_enter_sleep和msm_gpio_enter_sleep将sirc和gpio都带入休眠状态。</P>
<p>
用msm_pm_poll_state等待modem的响应，之后用中断回调enter_sleep2完成中断睡眠的第二步，保存当前中断寄存器VIC_IRQ_STATUS0的环境，并将当前pend的中断读清10次。如果在第10次之前中断已经被读清，则退出。</P>
<p>
用msm_pm_config_hw_before_power_down设置APPS_CLK_SLEEP_EN和APPS_PWRDOW</P>
<p>N寄存器。acpuclk_power_collapse设置core的clk速率。</P>
<p>
msm_pm_boot_config_before_pc中的全局指针msm_pm_boot_before_pc在PM初始化的时候赋值，具体流程如下：</P>
<p>
msm_pm_boot_init初始化的时候，将物理地址0转换成对应的虚拟地址，等于把0地址赋给全局指针msm_pm_reset_vector，使得该全局指针指向0地址，之后将msm_pm_config_rst_vector_before_pc和msm_pm_config_rst_vector_after_pc赋给msm_pm_boot_before_pc和msm_pm_boot_after_pc。</P>
<p>
msm_pm_config_rst_vector_before_pc中先将msm_pm_reset_vector及下个int地址(即0地址和4地址)的值保存到saved_vector[0]和saved_vector[1]中，在唤醒后会通过msm_pm_config_rst_vector_after_pc接口恢复，之后将指令0xE51FF004对应ldr
pc,
4和唤醒后要跳到的函数msm_pm_collapse_exit(先转换成虚拟地址)接口赋给msm_pm_reset_vector[0]和msm_pm_reset_vector[1]，此时0地址的值是0xE51FF004也就是说一旦手机唤醒重启PC指向0地址执行的第一条指令就是0xE51FF004(ldr
pc, 4)，而4地址存放的是msm_pm_collapse_exit，之前用两条指令而不是直接用b
msm_pm_collapse_exit是因为b的最大寻址范围是64M。</P>
<p>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
而实际保存的过程发生在待机流程的最后，通过调用msm_pm_boot_config_before_pc接口完成第一个函数msm_pm_collapse_exit的保存。</P>
<p>
最后msm_pm_collapse汇编程序完成CPU寄存器和CP15寄存器的保存，实际保存到去全局指针msm_saved_state中，&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
DELAY_8x25 300表示延时，执行到这条指令后，app就等待modem给app自己掉电了。</P>
<p>&nbsp;<wbr></P>
<p><b>内核机制</B></P>
<p>1、共享内存操作接口smsm_get_state()</P>
<p>enum {</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_APPS_STATE,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_MODEM_STATE,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_Q6_STATE,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_APPS_DEM,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_WCNSS_STATE = SMSM_APPS_DEM,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_MODEM_DEM,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_DSPS_STATE = SMSM_MODEM_DEM,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_Q6_DEM,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_POWER_MASTER_DEM,</P>
<p>
&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
SMSM_TIME_MASTER_DEM,</P>
<p>};</P>
<p>2、smsm_change_state修改共享内存的状态</P>
<p>&nbsp;<wbr></P>
<p>待机的完整log和注释如下：</P>
<p>
<b>Log</B><b>中的时间用的不是系统中的tick</B><b>，而是内核系统时的一个timer</B><b>，当手机待机休眠时该定时器也停止运行，再次唤醒时定时器又开始工作，中间的时间直接忽略。涉及到printk</B><b>的机制。</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.553103]
POWERKEY:report_hs_key&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
301&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
key = 107&nbsp;<wbr> key_code = 81</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.791274]
POWERKEY:report_hs_key&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
301&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
key = 107&nbsp;<wbr> key_code = 255</P>
<p><b>下面是应用设置背光的接口点灭led</B><b>灯。</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.795234]
msm_fb_set_backlight, set backlight 76</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.811784]
msm_fb_set_backlight, set backlight 70</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.829413]
msm_fb_set_backlight, set backlight 65</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.845274]
msm_fb_set_backlight, set backlight 59</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.861524]
msm_fb_set_backlight, set backlight 54</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.877766]
msm_fb_set_backlight, set backlight 49</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.893576]
msm_fb_set_backlight, set backlight 43</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.910253]
msm_fb_set_backlight, set backlight 38</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.925294]
msm_fb_set_backlight, set backlight 32</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.941146]
msm_fb_set_backlight, set backlight 26</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.956868]
msm_fb_set_backlight, set backlight 22</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.973761]
msm_fb_set_backlight, set backlight 16</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 40.990439]
msm_fb_set_backlight, set backlight 10</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.006128]
msm_fb_set_backlight, set backlight 5</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.021974]
msm_fb_set_backlight, set backlight 0</P>
<p><b>状态的切换从on(0)</B><b>到mem(3)</B><b>。</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.024264]
request_suspend_state: sleep (0-&gt;3, old_sleep 0) at
41027286655 (1980-01-06 02:53:47.479806664
UTC)1980的这个时间是系统的tick计算出来的时间，这个是最准的。</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.024799]
request_suspend_state: goto late resume.state 1</P>
<p>[ 41.025153] request_suspend_state:end of function. new_state 3,
old_state 0,</P>
<p>requested_suspend_state 3</P>
<p>
<b>early_suspend</B><b>是进入浅度睡眠的接口，会关掉传感器和LCD</B><b>等设备，此时电流在40~200mA</B><b>。</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.026083] early_suspend:
state 1</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.026293] early_suspend:
call handlers</P>
<p>[ &nbsp;<wbr>&nbsp;<wbr>41.026553] early_suspend:
calling bma250x_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.027336] sensor:
de-active adxl346 sensor!</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.027651] early_suspend:
calling msm_batt_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.052741] bma250x ioctl
get an inlegal command from user. 0x4004afa3</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.055999] early_suspend:
calling ft5x06_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.056464] sensor:
de-active adxl346 sensor!</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.064173]
ft5x06_early_suspend(drivers/input/touchscreen/ft5x06_ts_hs.c:1307)
- -**</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.082558] early_suspend:
calling stop_drawing_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.092036] early_suspend:
calling kgsl_early_suspend_driver</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.092989] early_suspend:
calling msmfb_bl_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.093004]
msmfb_bl_early_suspend, 208</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.093016]
msm_fb_set_backlight, set backlight 0</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.094088] early_suspend:
calling msmfb_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.277651]
mipi_dsi_panel_msm_power</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.278021] early_suspend:
calling mdp_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.278223] early_suspend:
calling msmsdcc_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.278409] early_suspend:
calling msmsdcc_early_suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.278593] early_suspend:
calling msmsdcc_early_suspend</P>
<p><b>停掉用户进程</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.294909] Freezing user
space processes ... (elapsed 0.02 seconds) done.</P>
<p><b>停掉内核中的守护进程</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.567013] Freezing
remaining freezable tasks ... (elapsed 0.01 seconds) done.</P>
<p><b>停止控制台</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.587183] Suspending
console(s) (use no_console_suspend to debug)</P>
<p>
<b>后面的log</B><b>在手机休眠的时候已经打印不出来了，而是缓存在buffer</B><b>中，待下次唤醒的时候控制台被唤醒，buffer</B><b>的信息一下显示到串口上。</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.590261]
msmrtc_virtual_alarm_set
a-&gt;enabled=1&nbsp;<wbr> hour=0
min=0&nbsp;<wbr> sec=0</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.592034]
radio-tavaruatavarua_suspend: radio suspend</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.716409]
msm_sdcc_setup_power:ignore the power off eMMC</P>
<p><b>挂起设备</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.777744] PM: suspend of
devices complete after 189.908 msecs</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.777758]
POWERKEY:&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
suspend_enter&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
140</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.779293] PM: late
suspend of devices complete after 1.506 msecs</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.779306]
POWERKEY:&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
suspend_enter&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
151</P>
<p><b>AP</B><b>侧的core0</B><b>给core1</B> <b>置disable</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.779351] Disabling
non-boot CPUs ...</P>
<p>&nbsp;<wbr></P>
<p>三、唤醒流程简介</P>
<p>
按键按下后，modem会响应这个中断，modem首先把自己内部停掉的部分重新开启，之后再给app侧的cpu上电，CPU上电后pc指针指向0地址，此时会运行之前在待机时存放在0地址的指令，即对应msm_pm_collapse_exit接口。</P>
<p>
msm_pm_collapse_exit首先恢复之前保存的各种配置，包括CPU的寄存器，CP15的配置等，通过全局指针msm_saved_state_phys来转换，待机前是保存到了全局指针msm_saved_state上面，在初始化的时候msm_pm_init中会将msm_saved_state_phys之后84个字节11个寄存器R4~R11、10给CP15寄存器通过ioremap赋给全局指针msm_saved_state，所以待机前的复制其实也是赋给了msm_saved_state_phys，msm_pm_collapse_exit恢复cpu寄存器和cp15寄存器之后用blx
lr指令跳回到之前待机时执行的最后一个函数msm_pm_power_collapse的msm_pm_collapse后面继续执行，设置函数的返回值为1。</P>
<p>msm_pm_power_collapse是唤醒后执行的第一个C函数，先调用msm_pm_boot_config_</P>
<p>
after_pc恢复之前保存到全局变量saved_vector[0]和saved_vector[1]中的指令(即之前0地址和4地址的指令)。根据之前的返回值是1，即局部变量collapsed为1，用cpu_init完成ap侧core0的初始化，用local_fiq_enable使能本地的fiq中断。用acpuclk_set_rate恢复之前core
clk rate(保存到局部变量saved_acpuclk_rate中)。</P>
<p>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
完成唤醒的中断准备步骤1，msm_pm_irq_extns-&gt;exit_sleep1等，执行的就是之前挂起执行的逆操作，调用msm_pm_timer_exit_suspend、syscore_resume、arch_suspend_enable_irqs等。</P>
<p>
调用中断接口msm_pm_irq_extns-&gt;exit_sleep2(msm_irq_exit_sleep2)恢复中断寄存器的设置，将刚才pending的中断(通过读取VIC_IRQ_STATUS0对应的偏移地址寄存器得知)，写到VIC_SOFTINT0寄存器的偏移地址中，用mb实现内存屏障保证程序的串行执行。全局变量msm_irq_to_smsm保存共享内存的中断号。</P>
<p>&nbsp;<wbr></P>
<p>唤醒设备的原因有三个：</P>
<p>1、&nbsp;<wbr> modem(短信或者电话)；</P>
<p>2、&nbsp;<wbr> 按键、耳机或者USB的中断；</P>
<p>3、&nbsp;<wbr> Alarm 应用发生RTC</P>
<p>&nbsp;<wbr></P>
<p><b>内核机制</B></P>
<p>1、msm_pm_add_stat(id, time)用来累计消耗的时间并打出log。</P>
<p>&nbsp;<wbr></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.781921]
POWERKEY:&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
suspend_enter&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
185</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.782039]
POWERKEY:&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
msm_pm_power_collapse&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>&nbsp;<wbr>
980</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.782039] irq_mask =
0x2000000&nbsp;<wbr> wakeup_reason = 0x1 pending_irqs = 0x0
gpio = 0x0</P>
<p><b>提示唤醒源来自于RPC</B><b>共享内存交互</B></P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.782229] wakeup wake
lock: rpcrotuer_smd_xprt</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.782554] Enabling
non-boot CPUs ...</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.784899] CPU1 is up</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.785409] PM: early
resume of devices complete after 0.490 msecs</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.790081]
radio-tavaruatavarua_resume: radio resume</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.792373] PM: resume of
devices complete after 5.548 msecs</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.899001] Restarting
tasks ...</P>
<p>[&nbsp;<wbr>&nbsp;<wbr> 41.933118] done.</P>
<p>&nbsp;<wbr></P>							
		</div>
						<!-- 正文结束 -->
		<div id='share' class="shareUp">
        	<div class="share SG_txtb">
			分享： 
			<div class="bshare-custom" style="display:inline;margin-left:5px;"><a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a><a title="分享到QQ空间" class="bshare-qzone" href="javascript:void(0);"></a><a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
			</div>
			</div>
            <div class="up">
	        	<div title="喜欢后让更多人看到" id="dbox_45dc1205010177dg" class="upBox upBox_click" style="cursor: pointer;">
	            	<p ti_title="待机和唤醒" id="dbox2_45dc1205010177dg" class="count" ></p>
	                <p class="link"><img width="15" height="15" align="absmiddle" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" class="SG_icon SG_icon34">喜欢</p>
	            </div>
<!--
                <div class="upBox upBox_add">
                    <p class="count">0</p>
                    <p class="link"><img width="20" height="16" align="absmiddle" title="推荐" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" class="SG_icon SG_icon214">赠金笔</p>
                </div>
-->
                                <div class="upBox upBox_add">
                    <p class="count" id="goldPan-num">0</p>
                    <p class="link" id="goldPan-give"><img class="SG_icon SG_icon214" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" width="20" height="16" title="赠金笔" align="absmiddle">赠金笔</p>
                </div>
                
	        </div>
            <div class="clearit"></div>
		</div>
		<div class="articalInfo">
			<!-- 分享到微博 {$t_blog} -->
			<div class="IL">
				阅读<span id="r_45dc1205010177dg" class="SG_txtb"></span><em class="SG_txtb">┊</em> 
				<a href="#commonComment">评论</a> <span id="c_45dc1205010177dg" class="SG_txtb"></span><em class="SG_txtb">┊</em>				<a href="javascript:;" onclick="$articleManage('45dc1205010177dg',5);return false;">收藏</a><span id="f_45dc1205010177dg"  class="SG_txtb"></span>
				<em class="SG_txtb">┊</em><a href="#" id="quote_set_sign" onclick="return false ;">转载</a><a  href="#" id="z_45dc1205010177dg" onclick="return false ;" class="zznum"></a>				<span id="fn_待机和唤醒" class="SG_txtb"></span><em class="SG_txtb">┊</em>
				<a onclick="return false;" href="javascript:;" ><cite id="d1_digg_45dc1205010177dg">喜欢</cite></a><a id="d1_digg_down_45dc1205010177dg" href="javascript:;" ><b>▼</b></a>
									<em class="SG_txtb">┊</em><a href="http://blog.sina.com.cn/main_v5/ria/print.html?blog_id=blog_45dc1205010177dg" target="_blank">打印</a><em class="SG_txtb">┊</em><a id="q_45dc1205010177dg" onclick="report('45dc1205010177dg');return false;" href="#">举报</a>
											</div>
			<div class="IR">
				<table>
					<tr>
											<th class="SG_txtb" scope="row">已投稿到：</th>
						<td>
							<div class="IR_list">
								<span><img class="SG_icon SG_icon36" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" width="15" height="15" title="排行榜" align="absmiddle" /> <a href="http://blog.sina.com.cn/lm/114/117/day.html" class="SG_linkb" target="_blank">排行榜</a></span>							</div>
						</td>
										</tr>
									</table>
			</div>
		</div>
		<div class="clearit"></div>
		<div class="blogzz_zzlist borderc" id="blog_quote" style="display:none">加载中，请稍候......</div>
		<div class="articalfrontback SG_j_linedot1 clearfix" id="new_nextprev_45dc1205010177dg">
							<div><span class="SG_txtb">前一篇：</span><a href="http://blog.sina.com.cn/s/blog_45dc1205010171dp.html">memory学习总结读写操作</a></div>
								</div>
		<div class="clearit"></div>
							
		<div id="loginFollow"></div>
				<div class="allComm">
			<div  class="allCommTit" >
				<div class="SG_floatL">
				    <strong>评论</strong>
				    <span id="commAd_1" style="display:none;">
				        <span style="margin-left:15px; width:220px; display:inline-block;"><a target="_blank" href="http://blog.sina.com.cn/lm/8/2009/0325/105340.html">重要提示：警惕虚假中奖信息</a></span>
				    </span>
				</div>
				<div class="SG_floatR"><a class="CP_a_fuc" href="#post">[<cite>发评论</cite>]</a></div>
			</div>
			<ul id="article_comment_list" class="SG_cmp_revert"><!-- 循环始 --><li>评论加载中，请稍候...</li><!-- 循环终  --></ul>
			<div class="clearit"></div>
			<div class="myCommPages SG_j_linedot1">
				<div class="SG_page" id="commentPaging" style="display:none;">
					<ul class="SG_pages">
					</ul>
				</div>
				<div class="clearit"></div>
			</div>
			<a name="post"></a>
			<div class="writeComm">
				<div class="allCommTit">
					<div class="SG_floatL">
					    <strong>发评论</strong>
					    <span></span>
					</div>
					<div class="SG_floatR"></div>
				</div>
				<div class="wrCommTit">
					<div class="SG_floatL" id="commentNick" style="display:none;"></div>
				</div>
				<div class="formTextarea">
					<div style="float:left;" id="commonComment">
					<iframe id="postCommentIframe"  frameborder="0" style="border:1px solid #C7C7C7;
		height:158px;width:448px;maring-top:1px;background-color:white;" src="http://blog.sina.com.cn/main_v5/ria/blank2.html"></iframe>
					<textarea id="commentArea" tabindex="1" style="display:none;"></textarea>
					</div>
					<div id="mobileComment" style="float:left;display:none;">
						<textarea id="mbCommentTa" style="width:438px;height:150px;border:1px solid #C7C7C7;line-height:18px;padding:5px;"></textarea>
					</div>
					<div class="faceblk" id="faceWrap">
						<div id="smilesSortShow" class="faceline1">
						</div>
						<ul id="smilesRecommended" class="faceline01"></ul>
					</div>
					<div class="clearit"></div>
				</div>
				<div class="formLogin">
					<div class="SG_floatL"> 
					<p id="commentlogin" style="display:none;"><span>登录名：</span><input type="text" style="width: 115px;" id="login_name" tabindex="2"/>   <span>密码：</span><input type="password" style="width: 115px;" id="login_pass" tabindex="3"/>   <a href="http://login.sina.com.cn/getpass.html" target="_blank">找回密码</a>   <a href="http://login.sina.com.cn/signup/signup.php?entry=blog&src=blogicp&srcuid=1172050437" target="_blank">注册</a>	<input type="checkbox" id="login_remember"/><label for="login_remember" style="display:inline-block;" title="建议在网吧/公用电脑上取消该选项">记住登录状态</label></p><p id="commentloginM" style="display:none;"><span>昵&nbsp;&nbsp;&nbsp;称：</span><input type="text" style="width: 115px;" id="comment_anonyous"  value="新浪网友"/ tabindex="2" disabled></p><p id="quote_comment_p"><input type="checkbox" id="bb"> <label for="bb"><img height="18" align="absmiddle" width="18" title="" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" class="SG_icon SG_icon110">分享到微博 <img height="15" align="absmiddle" width="15" title="新" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" class="SG_icon SG_icon11"></label>&nbsp;&nbsp;&nbsp;<input type="checkbox" id="cbCommentQuote" /><label for="cbCommentQuote">评论并转载此博文</label><img class="SG_icon SG_icon11" src="http://simg.sinajs.cn/blog7style/images/common/sg_trans.gif" width="15" height="15" title="新" align="absmiddle" /></p>
					<p id="geetest-box" ></p>
					</div>

					<span style="display: none; color: rgb(153, 153, 153); margin-left: 10px;" id="login_remember_caution"></span>

											<div class="SG_floatR" id="anonymity_cont"><input type="checkbox" id="anonymity"/><label for="anonymity">匿名评论</label></div>
									</div>
				<div class="formBtn">
					<a href="javascript:;" onclick="return false;" class="SG_aBtn" tabindex="5"><cite id="postcommentid">发评论</cite></a>
					<p class="SG_txtc">以上网友发言只代表其个人观点，不代表新浪网的观点或立场。</p>
				</div>
			</div>
		</div>
				<div class="clearit"></div>
		
				<div class="articalfrontback articalfrontback2 clearfix">
						  <div class="SG_floatL"><span class="SG_txtb">&lt;&nbsp;前一篇</span><a href="http://blog.sina.com.cn/s/blog_45dc1205010171dp.html">memory学习总结读写操作</a></div>
								</div>
		<div class="clearit"></div>
				
	</div>
	<!--博文正文 end -->
		<script type="text/javascript">
			var voteid="";
		</script>

            </div>       
            <div class="SG_connFoot"></div>
          </div>
</div>
	<!--第二列start-->
	
	<!--第三列start-->
	<div id="column_3" class="SG_colWnone"><div style="width:0px;height:0.1px;margin:0px;">&nbsp;&nbsp;</div></div>
	<!--第三列end-->

	
    </div>
   <!--主题内容结束 -->
  

	<div id="diggerFla" style="position:absolute;left:0px;top:0px;width:0px"></div>
    <div class="sinablogfooter" id="sinablogfooter"  style="position:relative;">
      
      <p class="SG_linka"><a href="http://help.sina.com.cn/index.php?s=askquestion&a=view" target="_blank">新浪BLOG意见反馈留言板</a>　<a href="javascript:;" onclick="window.open ('http://control.blog.sina.com.cn/admin/advice/impeach.php?url=http%3A//blog.sina.com.cn/s/blog_4cf7b4ec0100eudp.html%3Ftj%3D1', '','height=495, width=510, top=0, left=0, toolbar=no, menubar=no, scrollbars=no, resizable=no,location=n o, status=no');">不良信息反馈</a>　电话：4006900000 提示音后按1键（按当地市话标准计费）　欢迎批评指正</p>
   
      <p class="SG_linka"><a href="http://corp.sina.com.cn/chn/" target="_blank">新浪简介</a> | <a href="http://corp.sina.com.cn/eng/" target="_blank">About Sina</a> | <a href="http://emarketing.sina.com.cn/" target="_blank">广告服务</a> | <a href="http://www.sina.com.cn/contactus.html" target="_blank">联系我们</a> | <a href="http://corp.sina.com.cn/chn/sina_job.html" target="_blank">招聘信息</a> | <a href="http://www.sina.com.cn/intro/lawfirm.shtml" target="_blank">网站律师</a> | <a href="http://english.sina.com" target="_blank">SINA English</a> | <a href="http://members.sina.com.cn/apply/" target="_blank">会员注册</a> | <a href="http://help.sina.com.cn/" target="_blank">产品答疑</a> </p>
      <p class="copyright SG_linka"> Copyright &copy; 1996 - 2016 SINA Corporation,  All Rights Reserved</p>
      <p class="SG_linka"> 新浪公司 <a href="http://www.sina.com.cn/intro/copyright.shtml" target="_blank">版权所有</a></p>
	  <a href="http://www.bj.cyberpolice.cn/index.jsp"  target="_blank" class="gab_link"></a>
    </div>
  </div>
</div>
<div id="swfbox"></div>
<script id="PVCOUNTER_FORIE" type="text/javascript"></script>
</body>
<script type="text/javascript">
var scope = {
    $newTray : 1,
    $setDomain : true,
    $uid : "1172050437",
    $PRODUCT_NAME : "blog7",      //blog7photo,blog7icp
    $pageid : "article",
    $key :  "6c0e8d54b87f6ccc8948cb5085414f7d",
    $uhost : "",
    $ownerWTtype :"",
    $private: {"pageset":0,"tj":0,"adver":0,"sms":0,"ad":0,"blogsize":0,"cms":0,"hidecms":0,"top":0,"invitationset":0,"p4p":0,"spamcms":0,"init7":1,"quote":0,"foot":0,"headpic":0,"isMsnLink":0,"msnfeed":"000","isMsnMove":0,"isprivate":0,"t_sina":"1172050437","oauth_token":1,"oauth_token_secret":1,"uname":"","p_push_t":"1","p_get_t":"1"},
    $summary: "一、概述  点屏灭屏根本上是一个按键的输入操作，涉及的linux的输入设备管理，modem和app的通信，操作共享内存的机制等，简单流程...  (来自 @头条博客)",
    $is_photo_vip:0,
		 $nClass:0,
		 $articleid:"45dc1205010177dg",
		 $sort_id:117,
		 $cate_id:"",
		 $isCommentAllow:0,
		 $album_pic:"45dc1205x7b0598ff2b59",
		 $pn_x_rank:4,
		 $x_quote_c:"",
		 $flag2008:"",
		     component_lists:{"2":{"size":730,"list":[920]},"1":{"size":210,"list":[901,903,904]}},
    formatInfo:1,
    UserPic:[{"pid":null,"repeat":null,"align-h":null,"align-v":null,"apply":null},{"pid":null,"repeat":null,"align-h":null,"align-v":null,"apply":null},{"pid":null,"repeat":null,"align-h":null,"align-v":null,"apply":null}],
    UserBabyPic:{"photoX":0,"photoY":0,"photoURL":null,"angle":0,"zoom":0,"maskX":0,"maskY":0,"maskURL":null,"frameURL":null},
    UserColor:"",
    backgroundcolor:"",
    tpl:"30_1",
    reclist:0    };
var $encrypt_code = "0f49ab4bd4a9df24cd2fb65435cb35d3";
</script>

<script type="text/javascript" src="http://sjs.sinajs.cn/blog7common/js/boot.js"></script>
<script type="text/javascript">__load_js();</script>
<script type="text/javascript">__render_page();</script>


<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=b436f96b-ce3c-469f-93ca-9c0c406fcf10&amp;pophcol=2&amp;lang=zh"></script><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
<script type="text/javascript" charset="utf-8">
        bShare.addEntry({pic: "http://s10.sinaimg.cn/middle/45dc1205x7b0598ff2b59&amp;690", title:"分享自silvcn  《待机和唤醒》", summary:"一、概述  点屏灭屏根本上是一个按键的输入操作，涉及的linux的输入设备管理，modem和app的通信，操作共享内存的机制等，简单流程...  (来自 @头条博客)"});
     </script>
<script type="text/javascript" src="http://sjs.sinajs.cn/xblogtheme/js/blog680-min.js"></script>
<script type="text/javascript">
        var slotArr = ['atcTitLi_SLOT_41', 'atcTitLi_SLOT_42','loginBarActivity']; //广告位id
        var sourceArr = ['SLOT_41','SLOT_42','SLOT_43,SLOT_47,SLOT_48'];  //广告资源id
        SinaBlog680.staticBox(slotArr, sourceArr);
</script>
</html>
